# 502 Bad Gateway Xatosini Tuzatish

## Muammo

```
502 Bad Gateway
Access to fetch at 'https://logistic-career.onrender.com/api/auth/admin-login' 
from origin 'https://logistic-career.vercel.app' has been blocked by CORS policy
```

Bu shuni anglatadiki, backend Render.com'da **ishlamayapti** yoki **crash qilmoqda**.

## Yechim

### 1. Render.com Dashboard'da Log'larni Tekshiring

1. [Render.com Dashboard](https://dashboard.render.com) ga kiring
2. Backend service'ni tanlang
3. **Logs** tab'ini oching
4. Xatolik xabarlarini ko'ring

**Qidirish kerak bo'lgan xatoliklar:**
- `âŒ MongoDB connection error`
- `âŒ Server error`
- `âŒ Unhandled Rejection`
- `âŒ Uncaught Exception`
- `Error: listen EADDRINUSE`
- `MONGODB_URI topilmadi`

### 2. Environment Variables Tekshiring

Render.com Dashboard > Environment tab'ida quyidagilar bo'lishi kerak:

```
NODE_ENV=production
PORT=5000
MONGODB_URI=mongodb+srv://username:password@cluster.mongodb.net/logistic-career
JWT_SECRET=your-super-secret-jwt-key
JWT_EXPIRE=7d
OPENAI_API_KEY=sk-your-openai-api-key
FRONTEND_URL=https://logistic-career.vercel.app
```

**MUHIM:** Barcha variable'lar to'g'ri va to'liq bo'lishi kerak!

### 3. Service Status Tekshiring

Render.com Dashboard'da service status'ni tekshiring:
- âœ… **Running** - to'g'ri
- âŒ **Failed** - xatolik bor, log'larni tekshiring
- âŒ **Stopped** - service to'xtatilgan

### 4. Service'ni Qayta Deploy Qiling

1. **Manual Deploy** > **"Deploy latest commit"** ni bosing
2. Yoki yangi commit push qiling
3. Deploy progress'ni kuzatib turing

### 5. Tekshirish

Deploy bo'lgandan keyin:

1. **Backend Health Check:**
   ```
   https://logistic-career.onrender.com/api/health
   ```
   
   Browser'da oching va javob ko'rinishi kerak:
   ```json
   {
     "success": true,
     "message": "Server is running",
     "timestamp": "2026-01-06T21:30:00.000Z"
   }
   ```

2. **Render.com Logs'da quyidagilarni ko'rasiz:**
   ```
   ðŸš€ Server is running on port 5000
   ðŸŒ Environment: PRODUCTION
   âœ… MongoDB Connected: ...
   ```

3. **Frontend'dan Login:**
   - `https://logistic-career.vercel.app/teacher/admin/role` ga kiring
   - Login qilib ko'ring
   - CORS xatosi yo'qolganini tekshiring

## Eng Keng Tarqalgan Xatoliklar

### 1. MongoDB Connection Xatosi

**Xatolik:**
```
âŒ MongoDB connection error: ...
```

**Yechim:**
- `MONGODB_URI` to'g'ri ekanligini tekshiring
- MongoDB Atlas'da IP whitelist'ni tekshiring (0.0.0.0/0 qo'shing)
- MongoDB Atlas'da database user yaratilganligini tekshiring

### 2. Port Xatosi

**Xatolik:**
```
Error: listen EADDRINUSE: address already in use :::5000
```

**Yechim:**
- Render.com'da `PORT` environment variable'ni o'chirib tashlang (Render.com avtomatik beradi)
- Yoki `PORT` ni boshqa raqamga o'zgartiring

### 3. Environment Variable Topilmadi

**Xatolik:**
```
âŒ Xatolik: MONGODB_URI topilmadi!
```

**Yechim:**
- Render.com Dashboard > Environment tab'ida `MONGODB_URI` qo'shilganligini tekshiring
- Variable nomi to'g'ri ekanligini tekshiring (katta/kichik harf)
- Service'ni redeploy qiling

### 4. Build Xatosi

**Xatolik:**
```
npm ERR! code ELIFECYCLE
npm ERR! errno 1
```

**Yechim:**
- `package.json`'da `start` script to'g'ri ekanligini tekshiring
- `node_modules` to'g'ri o'rnatilganligini tekshiring
- Render.com'da `Build Command` va `Start Command` to'g'ri ekanligini tekshiring

## Troubleshooting

### Backend hali ham ishlamayapti?

1. âœ… Render.com Logs'ni to'liq o'qing
2. âœ… Environment variables to'g'ri qo'shilganligini tekshiring
3. âœ… Service status'ni tekshiring
4. âœ… Build log'larini tekshiring
5. âœ… MongoDB connection string to'g'ri ekanligini tekshiring

### CORS xatosi hali ham bor?

Agar backend ishlayapti, lekin CORS xatosi hali ham bor:
1. âœ… `FRONTEND_URL` to'g'ri qo'shilganligini tekshiring
2. âœ… `NODE_ENV=production` qo'shilganligini tekshiring
3. âœ… Service redeploy qilinganligini tekshiring

## Tezkor Test

Terminal'da:

```bash
# Health check
curl https://logistic-career.onrender.com/api/health

# CORS test
curl -H "Origin: https://logistic-career.vercel.app" \
     -H "Access-Control-Request-Method: POST" \
     -H "Access-Control-Request-Headers: Content-Type" \
     -X OPTIONS \
     https://logistic-career.onrender.com/api/auth/admin-login \
     -v
```

Javobda `Access-Control-Allow-Origin: https://logistic-career.vercel.app` bo'lishi kerak.

## Muhim Eslatmalar

- âœ… Backend ishlamasligi sababi - **log'larni tekshiring**
- âœ… 502 Bad Gateway = Backend ishlamayapti
- âœ… CORS xatosi = Backend javob bermayapti (502 sabab)
- âœ… Environment variable o'zgarganda **redeploy** kerak
- âœ… MongoDB connection xatoliklarini to'g'ri handle qilish kerak

